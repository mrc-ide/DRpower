---
title: "Analysing data"
author: "Bob Verity"
date: "Last updated: `r format(Sys.Date(), '%d %b %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysing data}
  %\VignetteEngine{knitr::knitr}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(DRpower)
library(kableExtra)
library(tidyverse)
```

Here, we outline the main steps in analysing data using the DRpower Bayesian model.

## 1. Estimate prevalence

The main thing we want to estimate is usually the prevalence of *pfhrp2/3* deletions. This is extremely simple, and is carried out through the `get_prevalence()` function. We pass into this function two vectors of numbers; 1) the number of *pfhrp2/3* deletions observed in each cluster (numerator), and 2) the total sample size in each cluster (denominator):

```{r}
# define observed data
num_deletions <- c(3, 12, 4)
sample_size <- c(100, 130, 65)

# estimate prevalence
get_prevalence(n = num_deletions,
               N = sample_size)
```

We obtain an estimate of 6.81% with a 95% CrI in the range [2.30%, 19.52%]. When presenting our estimates we should always report the full credible interval and not just the central estimate of 6.81%, as this may give a misleading impression of our confidence.

## 2. Compare prevalence against threshold

The second thing we may want to do is to establish whether the prevalence is above the 5% threshold. The probability of being above this threshold is given in the `prob_above_threshold` output, in this case 0.8791. Before conducting this analysis, we should have decided what level of confidence we need in order to accept this hypothesis - we advise using 0.95 by default. In this case, 0.8791 is below 0.95 so we do not have sufficient evidence to conclude that prevalence is above 5%.

Note that it is possible for the CrI to span the 5% threshold, but for the `prob_above_threshold` to still be greater than 0.95. This is because the CrI is two-sided, whereas the hypothesis test is one sided.

## 3. Estimate the ICC

The prevalence estimates above have all uncertainty in the intra-cluster correlation (ICC) already taken into account. That being said, it can be useful to present our estimate of the ICC to help contextualise results, and to guide future studies. This can be achieved through the `get_ICC()` function:

```{r}
# estimate ICC
get_ICC(n = num_deletions,
        N = sample_size)
```

In this we estimate that the ICC is around 0.0074, and in the range [0, 0.1912]. This is a fairly low value of the ICC, which could be useful to know when conducting followup studies.
