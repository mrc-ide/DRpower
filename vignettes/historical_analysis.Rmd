---
title: "Historical analysis"
author: "Bob Verity"
date: "Last updated: `r format(Sys.Date(), '%d %b %Y')`"
output: html_document
vignette: >
  %\VignetteIndexEntry{Using DRpower for study design}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(DRpower)
library(ggridges)
library(kableExtra)
library(tidyverse)
```

## 1. Available data on *pfhrp2/3* deletions

Our objective here is to learn what we can from historical *pfhrp2/3* studies and to use this information to increase the power and validity of our approach. In particular, we are interested in coming up with sensible values for the intra-cluster correlation coefficient (ICC). Estimates of the ICC from historical data are vastly better than using simple rules of thumb, e.g. the commonly used 1.5 for the design effect, and thankfully the Bayesian framework gives us an excellent way of incorporating this information into our analys.

A large number of *pfhrp2/3* studies can be browsed through the [WHO malaria threats map](https://apps.who.int/malaria/maps/threats/). Although the data are not available for direct download from this site, they can be manually extracted, or in our case they were made available to us by request from the WHO. A data.frame giving all downloaded studies is available in the DRpower package through the `studies_inclusion` object. The raw data.frame consists of 94 studies. Our first step was to apply the following filters:

1. **Must have at least 10 samples total**. Less than this and there is very little information in the data, meaning our conclusions are driven by our priors.
2. **Must have at least 5 deletions total**. Although technically there is some information present on the ICC even when prevalence is zero, again we risk being strongly influenced by the prior.
3. **Must have data available at sub-ADMIN1 level**. We are interested in estimating the ICC at the province (ADMIN1) level, meaning we need data at this level of spatial resolution.
4. **Data must be from symptomatic individuals**. We are interested in *clinically relevant* *pfhrp2/3* deletions, and so we exclude studies on asymptomatic individuals.

This filtered us down to 12 studies. Granular data from these 12 studies is available within the package through the `historical_data` object. At this point, a further sub-study filter was applied:

1. **An ADMIN1 unit is must contain data from 3 or more sites within the same sampling year**. Multiple sites are needed to provide information on the ICC, and 3 sites was chosen as a minimum as this is more informative than e.g. 2 sites while still providing adequate data.

After applying this filter, data remained from 5 studies covering 4 countries and 6 ADMIN1 regions:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# subset to ADMIN1 regions that have data for 3 or more lower geographical units
# in the same year
multi_site <- historical_data %>%
  group_by(Paper_name, WHO_country_name, WHO_ADMIN1, Year) %>%
  summarise(unique_count = n()) %>%
  ungroup() %>%
  filter(unique_count >= 3) %>%
  mutate(study_ID = seq_along(unique_count)) %>%
  mutate(plot_name = sprintf("%s: %s\n(%s)", WHO_country_name, WHO_ADMIN1, Paper_name))

# make table
multi_site %>%
  left_join(studies_inclusion) %>%
  select(Paper_name, WHO_country_name, WHO_ADMIN1, Year, unique_count, Paper_link) %>%
  rename(Study_name = Paper_name,
         Country = WHO_country_name,
         ADMIN1 = WHO_ADMIN1,
         Num_sites = unique_count) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, extra_css = "border-bottom: 1px solid; border-top: 1px solid") %>%
  row_spec(6, extra_css = "border-bottom: 1px solid") %>%
  scroll_box(width = "700px", height = "300px")

```

<br>
<br>
The filtered data from these studies are shown below:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# merge dataset and finalise
dat_final <- multi_site %>%
  left_join(historical_data)

# make table
dat_final %>%
  select(Paper_name, WHO_country_name, WHO_ADMIN1, WHO_ADMIN2, WHO_village_or_health_facility,
         Year, Tested, Count_deletions) %>%
  rename(Study_name = Paper_name,
         Country = WHO_country_name,
         ADMIN1 = WHO_ADMIN1,
         ADMIN2 = WHO_ADMIN2,
         Site = WHO_village_or_health_facility,
         Deletions = Count_deletions) %>%
  kable() %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed")) %>%
  row_spec(0, extra_css = "border-bottom: 1px solid; border-top: 1px solid") %>%
  row_spec(29, extra_css = "border-bottom: 1px solid") %>%
  scroll_box(width = "700px", height = "300px")
```

## 2. Estimating the ICC

We can estimate the ICC using the Bayesian model in DRpower by running the `get_ICC()` function.

