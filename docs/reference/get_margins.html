<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Margin of error calculations when estimating prevalence from a
  clustered survey — get_margins • DRpower</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Margin of error calculations when estimating prevalence from a
  clustered survey — get_margins"><meta property="og:description" content="Calculate the expected margin of error when estimating
  prevalence from a clustered survey. Alternatively, calculate the sample
  size required to achieve a given target margin of error."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DRpower</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    How it works
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/rationale1_background.html">Background</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Analysing data</li>
    <li>
      <a href="../articles/rationale2_issue.html">CIs and overdispersion</a>
    </li>
    <li>
      <a href="../articles/rationale3_design_effect.html">The design effect</a>
    </li>
    <li>
      <a href="../articles/rationale4_weaknesses.html">Weaknesses with the traditional approach</a>
    </li>
    <li>
      <a href="../articles/rationale5_bayesian.html">A Bayesian approach</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Designing a study</li>
    <li>
      <a href="../articles/rationale6_master_protocol.html">Sample size calculation in the 2020 master protocol</a>
    </li>
    <li>
      <a href="../articles/rationale7_ztest.html">The one-sample z-test</a>
    </li>
    <li>
      <a href="../articles/rationale8_power.html">Power and sample size in the DRpower model</a>
    </li>
  </ul></li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/tutorial_design.html">Designing a study</a>
    </li>
    <li>
      <a href="../articles/tutorial_analysis.html">Analysing data</a>
    </li>
  </ul></li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Misc
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/mathematical_details.html">Mathematical details</a>
    </li>
    <li>
      <a href="../articles/historical_analysis.html">Historical analysis</a>
    </li>
    <li>
      <a href="../articles/summarise_prevalence.html">How to summarise the prevalence</a>
    </li>
  </ul></li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/mrc-ide/DRpower/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Margin of error calculations when estimating prevalence from a
  clustered survey</h1>
    <small class="dont-index">Source: <a href="https://github.com/mrc-ide/DRpower/blob/HEAD/R/margins.R" class="external-link"><code>R/margins.R</code></a></small>
    <div class="hidden name"><code>get_margins.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Calculate the expected margin of error when estimating
  prevalence from a clustered survey. Alternatively, calculate the sample
  size required to achieve a given target margin of error.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">get_margin</span><span class="op">(</span><span class="va">N</span>, <span class="va">n_clust</span>, prevalence <span class="op">=</span> <span class="fl">0.2</span>, ICC <span class="op">=</span> <span class="fl">0.05</span>, alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">get_sample_size_margin</span><span class="op">(</span></span>
<span>  <span class="va">MOE</span>,</span>
<span>  <span class="va">n_clust</span>,</span>
<span>  prevalence <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  ICC <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">get_margin_CP</span><span class="op">(</span><span class="va">N</span>, <span class="va">n_clust</span>, prevalence <span class="op">=</span> <span class="fl">0.2</span>, ICC <span class="op">=</span> <span class="fl">0.05</span>, alpha <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">get_sample_size_margin_CP</span><span class="op">(</span></span>
<span>  <span class="va">MOE</span>,</span>
<span>  <span class="va">n_clust</span>,</span>
<span>  prevalence <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  ICC <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  N_max <span class="op">=</span> <span class="fl">2000</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>N</dt>
<dd><p>the number of samples obtained from each cluster, assumed the same
over all clusters.</p></dd>


<dt>n_clust</dt>
<dd><p>the number of clusters.</p></dd>


<dt>prevalence</dt>
<dd><p>the true prevalence of the marker in the population as a
proportion between 0 and 1.</p></dd>


<dt>ICC</dt>
<dd><p>assumed true intra-cluster correlation (ICC) between 0 and 1.</p></dd>


<dt>alpha</dt>
<dd><p>the significance level of the CI.</p></dd>


<dt>MOE</dt>
<dd><p>the target margin of error.</p></dd>


<dt>N_max</dt>
<dd><p>the largest value of \(N\) to consider.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>the functions <code>get_margin()</code> and <code>get_margin_CP()</code> return
  the margin of error of the prevalence as a value between 0 and 1 (i.e. not
  as a %). In the case of <code>get_margin_CP()</code> a different MOE is returned
  for the upper and lower limits.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>A very common approach when constructing confidence intervals (CIs)
  from prevalence data is to use the Wald interval:</p>  
<p>$$\hat{p} \pm z\sqrt{\frac{\hat{p}(1 - \hat{p})}{N}}$$</p>  
<p>where \(\hat{p}\) is our estimate of the prevalence, \(z\) is the
  critical value of the normal distribution (\(z=1.96\) for a 95%
  interval) and \(N\) is the sample size. When estimating prevalence from a
  clustered survey we need to modify this formula as follows:</p>  
<p>$$\hat{p} \pm z\sqrt{\frac{\hat{p}(1 - \hat{p})}{Nc}(1 + (n - 1) r)}$$</p>  
<p>where \(\hat{p}\) is the <em>mean</em> prevalence over clusters, \(c\) is
  the number of clusters, and \(r\) is the intra-cluster correlation (ICC,
  a value between 0 and 1). The term to the right of the \(\pm\) symbol is
  called the <em>margin of error</em> (MOE). The function <code>get_margin()</code>
  returns this value.</p>  
<p>We can also rearrange this formula to get the sample size (\(N\))
  required to reach any given MOE:</p>  
<p>$$ N = \frac{ z^2p(1-p)(1-r) }{ cd^2 - z^2p(1-p)r } $$</p>  
<p>where \(d\) is the desired MOE. The function
  <code>get_sample_size_margin()</code> returns this value. Note that in some cases
  it might not be possible to achieve the specified MOE for any finite sample
  size due to the ICC introducing too much variation, in which case this
  formula will return a negative value and the function will return an error.</p>  
<p>Although this is a very common approach, it has a number of weaknesses.
  First, notice that we sneakily replaced \(\hat{p}\) with \(p\) when
  moving to the sample size formula above. This implies that there is no
  uncertainty in our prevalence estimation, which is not true. Also note that
  the Wald interval assumes that the sampling distribution of our estimator
  is Gaussian, which is also not true. The difference between the Gaussian
  and the true distribution is particularly pronounced when prevalence is at
  the extremes of the range (near 0% or 100%). In these cases, the Wald
  interval can actually include values less than 0 or greater than 1, which
  is nonsensical.</p>  
<p>An arguably better approach is to construct CIs using the method of Clopper
  and Pearson (1934). This confidence interval guarantees that the false
  positive rate is <em>at least</em> <code>alpha</code>, and in this sense is
  conservative. It is asymmetric and does not suffer from the problem of
  allowing values outside the [0,1] range. To make the Clopper-Pearson
  interval apply to a multi-cluster survey, we can use the idea of effective
  sample size, \(N_e\):</p>  
<p>$$ D_{eff} = 1 + (N - 1)r $$
  $$ N_e = \frac{N}{D_{eff}} $$</p>  
<p>We then calculate the CI as normal but using \(N_e\) in place of \(N\).
  The function <code>get_margin_CP()</code> returns the lower and upper MOE using
  the Clopper-Pearson interval, and the function
  <code>get_sample_size_margin_CP()</code> returns the corresponding sample size
  needed to achieve a certain MOE.</p>
<p>A third option is to use the DRpower model to estimate the credible
  interval of prevalence. See <code>?get_margin_Bayesian()</code> for how to
  estimate the margin of error under this method.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Clopper, C.J. and Pearson, E.S., 1934. The use of confidence or fiducial
limits illustrated in the case of the binomial. Biometrika, 26, 404–413. doi:
10.2307/2331986.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="fu">get_margin</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">60</span>, n_clust <span class="op">=</span> <span class="fl">3</span>, prevalence <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.1161369</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">get_sample_size_margin</span><span class="op">(</span>MOE <span class="op">=</span> <span class="fl">0.07</span>, n_clust <span class="op">=</span> <span class="fl">3</span>, prevalence <span class="op">=</span> <span class="fl">0.2</span>, ICC <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 72</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">get_margin_CP</span><span class="op">(</span>N <span class="op">=</span> <span class="fl">60</span>, n_clust <span class="op">=</span> <span class="fl">3</span>, prevalence <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     lower     upper </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.1560866 0.2788017 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu">get_sample_size_margin_CP</span><span class="op">(</span>MOE <span class="op">=</span> <span class="fl">0.14</span>, n_clust <span class="op">=</span> <span class="fl">3</span>, prevalence <span class="op">=</span> <span class="fl">0.2</span>, ICC <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 93</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Bob Verity, Shazia Ruybal.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

