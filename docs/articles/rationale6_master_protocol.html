<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sample Size Calculation in the 2020 WHO Master Protocol • DRpower</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Sample Size Calculation in the 2020 WHO Master Protocol">
<meta property="og:description" content="DRpower">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DRpower</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    How it works
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/rationale1_background.html">Background</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Analysing data</li>
    <li>
      <a href="../articles/rationale2_issue.html">CIs and overdispersion</a>
    </li>
    <li>
      <a href="../articles/rationale3_design_effect.html">The design effect</a>
    </li>
    <li>
      <a href="../articles/rationale4_weaknesses.html">Weaknesses with the traditional approach</a>
    </li>
    <li>
      <a href="../articles/rationale5_bayesian.html">A Bayesian approach</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Designing a study</li>
    <li>
      <a href="../articles/rationale6_master_protocol.html">Sample size calculation in the 2020 master protocol</a>
    </li>
    <li>
      <a href="../articles/rationale7_ztest.html">The one-sample z-test</a>
    </li>
    <li>
      <a href="../articles/rationale8_power.html">Power and sample size in the DRpower model</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/installation.html">Installation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tutorial_design.html">Designing a study</a>
    </li>
    <li>
      <a href="../articles/tutorial_analysis.html">Analysing data</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Misc
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mathematical_details.html">Mathematical details</a>
    </li>
    <li>
      <a href="../articles/historical_analysis.html">Historical analysis</a>
    </li>
    <li>
      <a href="../articles/summarise_prevalence.html">How to summarise the prevalence</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mrc-ide/DRpower/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Sample Size Calculation in the 2020 WHO Master
Protocol</h1>
                        <h4 data-toc-skip class="author">Bob Verity</h4>
            
            <h4 data-toc-skip class="date">Last updated: 30 Nov
2023</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mrc-ide/DRpower/blob/HEAD/vignettes/rationale6_master_protocol.Rmd" class="external-link"><code>vignettes/rationale6_master_protocol.Rmd</code></a></small>
      <div class="hidden name"><code>rationale6_master_protocol.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="the-2020-who-master-protocol">6. The 2020 WHO Master Protocol<a class="anchor" aria-label="anchor" href="#the-2020-who-master-protocol"></a>
</h2>
<p>In 2020, the WHO released the <a href="https://apps.who.int/iris/handle/10665/331197" class="external-link">Master Protocol for
surveillance of pfhrp2/3 deletions and biobanking to support future
research</a><span class="citation">(2020)</span>. The original version
of the Master Protocol recommended a sample size of 370 per domain,
split into 10 sites of 37 samples each. It was later found that there
were some numerical errors in this calculation, and the protocol was <a href="https://cdn.who.int/media/docs/default-source/malaria/diagnosis/9789240002050-corrigenda.pdf?sfvrsn=d67857_3" class="external-link">updated</a>
to 600 samples per domain. This larger sample size has increased power
and leads to more precise estimates of the prevalence of
<em>pfhrp2/3</em> deletions. However, there are some lingering issues
with the sample size argument that go deeper than simple numerical
errors, and that motivate the need for an alternative approach.</p>
<div class="section level3">
<h3 id="the-logic-behind-the-sample-size-calculation">6.1. The logic behind the sample size calculation<a class="anchor" aria-label="anchor" href="#the-logic-behind-the-sample-size-calculation"></a>
</h3>
<p>The recommended approach in the 2020 Master Protocol begins with
estimating the prevalence of deletions and constructing a 95% CI around
this estimate. There are three possible outcomes:</p>
<ul>
<li>Outcome 1: The upper limit of the 95% CI is below the 5% threshold
(<em>conclusion = low prevalence</em>).</li>
<li>Outcome 2: The lower limit of the 95% CI is above the 5% threshold
(<em>conclusion = high prevalence</em>).</li>
<li>Outcome 3: The 95% CI spans the 5% threshold
(<em>inconclusive</em>).</li>
</ul>
<p>Examples of these three outcomes are shown in the plot below:</p>
<p><img src="rationale6_master_protocol_files/figure-html/unnamed-chunk-3-1.png" width="480"></p>
<p>If outcome 2 is found in any domain then the country is recommended
to switch RDTs to a brand that does not rely exclusively on the HRP2
protein for detecting <em>P. falciparum</em>. If outcomes 1 or 3 are
detected in all domains then some form of periodic monitoring is still
advised, but the urgency is lower.</p>
<p>Let <span class="math inline">\(N\)</span> be the <em>total</em>
sample size over all sites (in our earlier notation we would say <span class="math inline">\(N=nc\)</span>, where <span class="math inline">\(n\)</span> is the per-site sample size and <span class="math inline">\(c\)</span> is the number of sites). The sample
size argument in the 2020 Master Protocol works by choosing a value of
<span class="math inline">\(N\)</span> such that the 95% CI exactly
touches the 5% threshold, but does not cross it. This leads to the
following formula:</p>
<p><span class="math inline">\(N \geq z_{\tiny 1 - \alpha/2}^2
\frac{\displaystyle p(1-p)}{\displaystyle (p-\mu)^2}D_{eff}\)</span></p>
<p>where <span class="math inline">\(p\)</span> is the true prevalence
of <em>pfhrp2/3</em> deletions, <span class="math inline">\(\mu\)</span>
is the threshold that we are comparing against (normally 5%), <span class="math inline">\(D_{eff}\)</span> is the design effect, and <span class="math inline">\(z_{\tiny 1 - \alpha/2}\)</span> is the two-tailed
critical value of the normal distribution at significance level <span class="math inline">\(\alpha\)</span> (for example, <span class="math inline">\(z_{\tiny 1 - \alpha/2}=1.96\)</span> for <span class="math inline">\(\alpha=0.05\)</span>). This formula can be found
on page 4 of the 2020 Master Protocol in slightly different
notation.</p>
<p>The sample size formula above has a direct connection to how we
calculate CIs. Recall from <a href="articles/rationale3_design_effect.html">previous sections</a> that
a standard way of constructing a confidence interval around the
prevalence estimate <span class="math inline">\(\hat{p}\)</span> is to
use the formula <span class="math inline">\(\hat{p} \pm z_{\tiny 1 -
\alpha/2}\sqrt{\frac{\displaystyle \hat{p}(1-\hat{p})}{\displaystyle
N}D_{eff}}\)</span>. If our objective is to make CIs just touch the
target threshold then we can achieve this by equating this formula to
<span class="math inline">\(\mu\)</span>. We can then rearrange the CI
formula in terms of <span class="math inline">\(N\)</span> to get the
sample size formula above (if you are handy with algebra you might want
to give this a go). Interestingly, we get the same formula whether we
treat the <span class="math inline">\(\pm\)</span> symbol as a plus
(upper CI) or a minus (lower CI), meaning we can use the same sample
size formula whether the prevalence is above or below the threshold. The
reason for highlighting this connection is to emphasize that <strong>the
sample size formula above is intrinsically linked to method for
calculating confidence intervals</strong>.</p>
<p>There is one subtle point worth mentioning; the sample size formula
from the Master Protocol is in terms of <span class="math inline">\(p\)</span>, but the CI formula is in terms of
<span class="math inline">\(\hat{p}\)</span>. The value <span class="math inline">\(p\)</span> is our assumed <em>true</em> prevalence
of deletions, whereas <span class="math inline">\(\hat{p}\)</span> is
our <em>estimate</em> of the prevalence of deletions. So <span class="math inline">\(p\)</span> is a fixed value but <span class="math inline">\(\hat{p}\)</span> will vary around the true value,
sometimes being slightly higher and sometimes slightly lower. This point
will become important later.</p>
</div>
<div class="section level3">
<h3 id="working-through-the-updated-protocol-numbers">6.2. Working through the updated protocol numbers<a class="anchor" aria-label="anchor" href="#working-through-the-updated-protocol-numbers"></a>
</h3>
<p>As mentioned in the introduction to this section, there were some
numerical mistakes in the original version of the Master Protocol that
meant the value <span class="math inline">\(N=370\)</span> had to be
revised. Let’s work through the revised protocol to update this value
ourselves.</p>
<p>The updated protocol assumes <span class="math inline">\(p=8\%\)</span> as a representative high prevalence
level (i.e., above 5%) and <span class="math inline">\(p=3.2\%\)</span>
as a representative low prevalence level. It uses a design effect of
<span class="math inline">\(D_{eff}=1.5\)</span> to account for
observations correlated within clinics. It also (somewhat confusingly)
mentions a 1-sided test at 95% confidence, which is at odds with the
description of a two-sided CI - we will assume a two-sided test
below.</p>
<p>For the high prevalence level we obtain:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.08</span></span>
<span><span class="va">Deff</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.05</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Deff</span> <span class="op">*</span> <span class="va">z</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p</span> <span class="op">-</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="co">#&gt; [1] 471.2189</span></span></code></pre></div>
<p>For the low prevalence level we obtain:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.032</span></span>
<span><span class="va">Deff</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.05</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Deff</span> <span class="op">*</span> <span class="va">z</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p</span> <span class="op">-</span> <span class="fl">0.05</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="co">#&gt; [1] 550.8937</span></span></code></pre></div>
<p>We would round these values to 472 and 551. These numbers are
slightly different to those in the updated protocol (500 and 584,
respectively), indicating there is still some discrepancy between the
formula in the protocol and how these values are calculated. Note that
we cannot fix this by using a one-sided assumption (<span class="math inline">\(z_{\tiny 1 - \alpha}=1.64\)</span>), as this leads
to different values again. The good news is that the updated Master
Protocol is conservative, rounding up to 600. The bad news is that even
this value is not sufficient to achieve good power due to deeper issues
with the approach.</p>
</div>
<div class="section level3">
<h3 id="issues-with-the-approach">6.3. Issues with the approach<a class="anchor" aria-label="anchor" href="#issues-with-the-approach"></a>
</h3>
<p>The main issue with the approach above is that it mixes
precision-based arguments with hypothesis testing. If we are trying to
design a study to achieve a particular margin of error around our
prevalence estimate then it makes sense to work from the CI formula
above - for example, we might want to estimate the prevalence of
<em>pfhrp2/3</em> deletions to within <span class="math inline">\(\pm\)</span> 10%. However, in the case of the
Master Protocol we will use the CI to make a categorical decision as to
whether prevalence is above or below a threshold, meaning this is more
akin to a hypothesis test. We can therefore ask - what is the power of
this test?</p>
<p>Statistical power is defined as the probability of correctly
rejecting the null hypothesis. In other words, it is the probably of
detecting an effect if it is really there. We want power to be high -
typically 80% or higher. In this particular use case, a high power means
our study has a good chance of concluding that the prevalence of
<em>pfhrp2/3</em> deletions is above 5% if it really is above 5%. If
power is low then our study has a good chance of missing this
interesting result, which begs the question of whether it was really
worth investing time and resources into a study that had a high chance
of failure.</p>
<p>Imagine we have chosen our sample size using the method above, such
that the lower CI just touches the 5% threshold. This is based on an
assumed true prevalence of <span class="math inline">\(p\)</span>, which
we will assume is <span class="math inline">\(p=8\%\)</span>. But the
estimated prevalence, <span class="math inline">\(\hat{p}\)</span>, will
vary around the true value, sometimes being higher and sometimes lower.
When it is lower, we will find that the CI crosses the 5% threshold and
we will get an inconclusive result. When it is higher, we will find that
it does not cross the 5% threshold and we will (correctly) conclude that
prevalence is above 5%. There is roughly equal chance that <span class="math inline">\(\hat{p}\)</span> is above or below <span class="math inline">\(p\)</span>, meaning we expect power to be around
50%. This is far below the usual level of 80% that is used when
designing a study.</p>
<p>We can explore this in various ways in code. First, let us completely
remove the design effect just to simplify the problem. This means we can
calculate the power of the approach exactly by brute force. The sample
size formula above would give <span class="math inline">\(N=315\)</span>
when <span class="math inline">\(D_{eff}=1\)</span>, so we will use this
value here.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># specify assumed values</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">315</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.08</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.05</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># calculate the lower CI for every possible observed number of deletions</span></span>
<span><span class="va">p_est</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">/</span> <span class="va">N</span></span>
<span><span class="va">CI_lower</span> <span class="op">&lt;-</span> <span class="va">p_est</span> <span class="op">-</span> <span class="va">z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">p_est</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_est</span><span class="op">)</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># establish if we get a conclusive high prevalence result for each possible</span></span>
<span><span class="co"># number of deletions, and weight this by the chance of each result to get the</span></span>
<span><span class="co"># total power</span></span>
<span><span class="va">conclude_high</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">CI_lower</span> <span class="op">&gt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="va">exact_power</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">conclude_high</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">dbinom</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="va">N</span>, <span class="va">N</span>, <span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">exact_power</span></span>
<span><span class="co">#&gt; [1] 0.4636098</span></span></code></pre></div>
<p>We can see that power is around 46%, which matches our intuition that
it should be around 50%. The slight discrepancy comes from the fact that
<span class="math inline">\(\hat{p}\)</span> is slightly more likely to
be below <span class="math inline">\(p\)</span> than above it for these
assumed values.</p>
<p>But what about if we include the design effect of <span class="math inline">\(D_{eff}=1.5\)</span>? Here, the formula gave <span class="math inline">\(N=472\)</span> for the same assumptions. It is
slightly tricky to evaluate the true power here - we have to use
simulation rather than brute force. We repeatedly simulate data with a
knwon level of intra-cluster correlation corresponding to our chosen
design effect, then we calculate CIs and proceed as normal.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">472</span>  <span class="co"># we will assume 8 clusters of 59 so we can hit this value exactly</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.08</span></span>
<span><span class="va">z</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fl">0.05</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">Deff</span> <span class="op">&lt;-</span> <span class="fl">1.5</span></span>
<span><span class="va">ICC</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">Deff</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">59</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># the ICC that corresponds to this Deff</span></span>
<span></span>
<span><span class="co"># simulate a large number of times</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">CI_lower</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">1e5</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">CI_lower</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># draw from a beta-binomial model with the chosen level of ICC</span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">DRpower</span><span class="fu">:::</span><span class="fu">rbbinom_reparam</span><span class="op">(</span>n_clust <span class="op">=</span> <span class="fl">8</span>, N <span class="op">=</span> <span class="fl">59</span>, p <span class="op">=</span> <span class="va">p</span>, rho <span class="op">=</span> <span class="va">ICC</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># calculate CIs taking into account the design effect</span></span>
<span>  <span class="va">p_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="va">N</span></span>
<span>  <span class="va">CI_lower</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">p_est</span> <span class="op">-</span> <span class="va">z</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">Deff</span> <span class="op">*</span> <span class="va">p_est</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p_est</span><span class="op">)</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># how often is the lower CI above the 5% threshold</span></span>
<span><span class="va">sim_power</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">CI_lower</span> <span class="op">&gt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim_power</span></span>
<span><span class="co">#&gt; [1] 0.49871</span></span></code></pre></div>
<p>Again, we find that power is around 50%. In other words, including
the design effect does not fix this issue, as the increased sample size
is matched by wider CIs. This would be true for any design effect.</p>
<p>Finally, what happens if we use the actual recommended value of <span class="math inline">\(N=600\)</span> from the updated Master Protocol?
Running the same simulation-based analysis but with 10 clusters of size
60 we obtain the following result:</p>
<pre><code><span><span class="co">#&gt; empirical power:</span></span>
<span><span class="co">#&gt; [1] 0.60766</span></span></code></pre>
<p>So power is still far below 80% even for the updated values. This is
not due to a numerical mistake, but rather is a fundamental issue with
the logic of the approach. We should not use the sample size formula
presented in section 6.1. The best way to deal with issue is to go back
to the drawing board and approach this from a different statistical
angle.</p>
<p align="center">
<button class="btn btn-primary" onclick="window.location.href='https://mrc-ide.github.io/DRpower/articles/rationale7_ztest.html';">
Next topic
</button>
</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-world2020master" class="csl-entry">
World Health Organization. 2020. <span>“Master Protocol for Surveillance
of Pfhrp2 Deletions and Biobanking to Support Future Research.”</span>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Bob Verity, Shazia Ruybal.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
